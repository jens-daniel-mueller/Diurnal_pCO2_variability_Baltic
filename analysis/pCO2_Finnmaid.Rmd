---
title: "Finnmaid pCO2"
author: "Jens Daniel Mueller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Data base

This analysis is based on pCO~2~ and SST observations from VOS Finnmaid, averaged for each crossing of subregions of the Baltic Sea.
The subregion "7. HGF" in front of Helsinki is selected, because this subregion is usually crossed in the morning (before arrival in Helsinki) and again in the evening of the same day (after departure from Helsinki), therefore allowing to investigate daytime variability. Mean CT values for each visit are calculate from measured pCO~2~, SST, and a fixed alkalinity assumption (which impacts absolute CT values but not relative changes reported here).

```{r load-packages, message=FALSE, warning=FALSE}

library(tidyverse)
library(lubridate)
library(seacarb)
library(scico)

df <- read_csv(here::here("/data", "Finnmaid_mean_area_CT_2019.csv"))

df <- df %>% 
  filter(Area == "7.HGF") %>% 
  arrange(date_mean) %>% 
    mutate(day = yday(date_mean),
         day_date = as.POSIXct(strptime(paste(2000,day), format = "%Y %j",tz="GMT")),
         hour = hour(date_mean),
         week = week(date_mean),
         year = year(date_mean))

```

# Daily pCO2, CT and SST amplitudes

As a first step, observations are selected from all days where the subregion "7. HGF" was visited twice. pCO~2~, SST, CT and time differences between morning and evening visit of the subregion are calculated. Thereafter, daytime changes per hour are calculated for pCO~2~, SST, and CT.

```{r diurnal-changes}

diurnal <-
df %>%
  add_count(year, day) %>% 
  filter(n == 2) %>% 
  group_by(year, day) %>%
  arrange(date_mean) %>%
  mutate(d_Tem = Tem_mean - lag(Tem_mean),
         d_CT = CT_mean - lag(CT_mean),
         d_pCO2 = pCO2_mean - lag(pCO2_mean),
         d_time = as.numeric(date_mean - lag(date_mean))) %>% 
  filter(!is.na(d_CT)) %>% 
  mutate(d_CT_hour = d_CT/d_time,
         d_pCO2_hour = d_pCO2/d_time,
         d_Tem_hour = d_Tem/d_time) %>% 
  ungroup()



ggplot(diurnal, aes(day, d_pCO2, fill=d_Tem_hour, size=d_time))+
  geom_hline(yintercept = 0)+
  geom_point(shape = 21)+
  scale_size(name="Duration (hr)")+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white",
                       name=expression(Delta~SST~(K~hr^{-1})))+
  labs(x="Day of year", y=expression(Delta~pCO2~(µatm)))+
  theme_bw()


ggplot(diurnal, aes(day, d_CT_hour, fill=d_Tem_hour, size=d_time))+
  geom_hline(yintercept = 0)+
  geom_point(shape = 21)+
  scale_size(name="Duration (hr)")+
  # scale_fill_gradientn(colors = rev(brewer_pal(10,"Spectral")),
  #                      name=expression(Delta~SST~(K~hr^{-1})))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white",
                       name=expression(Delta~SST~(K~hr^{-1})))+
  labs(x="Day of year", y=expression(Delta~DIC~(µmol~kg^{-1}~hr^{-1})))+
  theme_bw()


```

```{r plots}



weekly <-
  diurnal %>% 
  group_by(week) %>% 
  summarise(d_CT = mean(d_CT_hour),
         d_CT_max = max(d_CT_hour),
         d_CT_min = min(d_CT_hour),
         d_Tem = mean(d_Tem_hour),
         d_Tem_max = max(d_Tem_hour),
         d_Tem_min = min(d_Tem_hour)) %>% 
  ungroup()

ggplot()+
  geom_hline(yintercept = 0)+
  geom_point(data=weekly, aes(week, d_CT, fill=d_Tem), shape=21, size=3)+
  geom_path(data=weekly, aes(week, d_CT))+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", name=expression(Mean~Delta~SST~(K~hr^{-1})))+
  labs(x="Week of year", y=expression(Mean~Delta~DIC~(µmol~kg^{-1}~hr^{-1})))+
  theme_bw()
#ggsave("HGF_diurnal_dpCO2_week_mean.pdf", width = 297, height = 210, units = "mm", dpi=300)







```
